<!doctype html><html lang=ko dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>책뿌숴짐 - SQL 레벨업 9 | Jaejin's blog</title><meta name=keywords content="sql 튜닝"><meta name=description content="9장. 갱신과 데이터 모델 - 망치와 못 26강. 갱신을 효율적으로 갱신을 효율적으로 수행하는 SQL을 케이스 스터디 1. NULL 채우기 1 2 3 4 5 6 7 8 9 UPDATE OmitTbl SET val = (SELECT"><meta name=author content="Jaejin Jang"><link rel=canonical href=https://jaejin0me.github.io/post/posts182/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://jaejin0me.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://jaejin0me.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://jaejin0me.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://jaejin0me.github.io/apple-touch-icon.png><link rel=mask-icon href=https://jaejin0me.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-111561979-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"))</script><meta property="og:title" content="책뿌숴짐 - SQL 레벨업 9"><meta property="og:description" content="9장. 갱신과 데이터 모델 - 망치와 못 26강. 갱신을 효율적으로 갱신을 효율적으로 수행하는 SQL을 케이스 스터디 1. NULL 채우기 1 2 3 4 5 6 7 8 9 UPDATE OmitTbl SET val = (SELECT"><meta property="og:type" content="article"><meta property="og:url" content="https://jaejin0me.github.io/post/posts182/"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-05-29T01:39:17+09:00"><meta property="article:modified_time" content="2019-05-29T01:39:17+09:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="책뿌숴짐 - SQL 레벨업 9"><meta name=twitter:description content="9장. 갱신과 데이터 모델 - 망치와 못 26강. 갱신을 효율적으로 갱신을 효율적으로 수행하는 SQL을 케이스 스터디 1. NULL 채우기 1 2 3 4 5 6 7 8 9 UPDATE OmitTbl SET val = (SELECT"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://jaejin0me.github.io/post/"},{"@type":"ListItem","position":3,"name":"책뿌숴짐 - SQL 레벨업 9","item":"https://jaejin0me.github.io/post/posts182/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"책뿌숴짐 - SQL 레벨업 9","name":"책뿌숴짐 - SQL 레벨업 9","description":"9장. 갱신과 데이터 모델 - 망치와 못 26강. 갱신을 효율적으로 갱신을 효율적으로 수행하는 SQL을 케이스 스터디 1. NULL 채우기 1 2 3 4 5 6 7 8 9 UPDATE OmitTbl SET val = (SELECT","keywords":["sql 튜닝"],"articleBody":"9장. 갱신과 데이터 모델 - 망치와 못 26강. 갱신을 효율적으로 갱신을 효율적으로 수행하는 SQL을 케이스 스터디 1. NULL 채우기 1 2 3 4 5 6 7 8 9 UPDATE OmitTbl SET val = (SELECT val FROM OmitTbl\tOT1 WHERE OT1.keycol = (SELECT MAX(seq) FROM OmitTbl OT2 WHERE OT2.keycol = OmitTbl.keycol AND OT2.seq \u003c OmitTbl.seq AND OT2.val IS NOT NULL)) WHERE val IS NULL; 2. 반대로 NULL을 설정 1 2 3 4 5 6 7 8 9 10 11 12 UPDATE OmitTbl SET val = CASE WHEN val = (SELECT val FROM OmitTbl 01 WHERE 01.keycol = OmitTbl.keycol AND 01.seq = (SELECT MAX(seq) FROM OmitTbl 02 WHERE 02.keycol = OmitTbl.keycol AND 02.seq \u003c OmitTbl.seq)) THEN NULL ELSE val END; 27강. 레코드에서 필드로의 갱신 1. 필드를 하나씩 갱신 1 2 3 4 5 6 7 8 9 10 11 12 13 UPDATE ScoreCols SET score_en = (SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '영어'), score_nl = (SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '국어'), score_mt = (SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '수학'); 명확하지만 항목별로 서브쿼리를 필요로하기 때문에 비효율적이다. 2. 다중 필드 할당 여러 개의 필드를 리스트화하고 한번에 갱신 1 2 3 4 5 6 7 8 9 10 11 12 13 UPDATE ScoreCols SET (score_en, score_nl, score_mt) = (SELECT MAX(CASE WHEN subject = '영어' THEN score ELSE NULL END) AS score_en, MAX(CASE WHEN subject = '국어' THEN score ELSE NULL END) AS score_nl, MAX(CASE WHEN subject = '수학' THEN score ELSE NULL END) AS score_mt FROM ScoreRows SR WHERE SR.student_id = ScoreCols.student_id); 상관 서브쿼리가 하나로 정리된 대신, ScoreRows 테이블에 대한 접근이 INDEX UNIQUE SCAN -\u003e INDEX RANGE SCAN, MAX 함수의 정렬리 추가되므로 트레이드오프가 있다. 1) 다중 필드 할당 2) 스칼라 서브쿼리 MAX함수를 적용해 집약시킴으로써 가능해진다. 3. NOT NULL 제약이 걸려있는 경 1) UPDATE 구문 사용 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 UPDATE ScoreColsNN SET score_en = COALESCE((SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '영어'), 0), score_nl = COALESCE((SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '국어'), 0), score_mt = COALESCE((SELECT score FROM ScoreRow SR WHERE SR.studend_id = ScoreCols.studend_id AND subject = '수학'), 0); WHERE EXISTS (SELECT * FROM ScoreRows WHERE student_id = ScoreColsNN.studend_id); 테이블 사이에 일치하지 않는 레코드는 제거 학생은 존재하지만 과목이 없는 경우 처리 2) MERGE 구문 사용 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 MERGE INTO ScoreColsNN USING (SELECT student_id, COALESCE(MAX(CASE WHEN subject = '영어' THEN score ELSE NULL END), 0) AS Score_en, COALESCE(MAX(CASE WHEN subject = '국어' THEN score ELSE NULL END), 0) AS Score_nl, COALESCE(MAX(CASE WHEN subject = '수학' THEN score ELSE NULL END), 0) AS Score_mt FROM ScoreRows GROUP By studend_id) SR ON\t(ScoreColsNN.student_id = SR.student_id) WHEN MATCHED THEN UPDATE SET ScoreColsNN.score_en = SR.score_en, coreColsNN.score_nl = SR.score_nl, ScoreColsNN.score_mt = SR.score_mt; 결합조건을 ON 구 하나에 묶을 수 있다. ScoreRows 테이블 풀 스캔 1회 + 정렬 1회로 고정된다. 나은 선택지로 고려해볼만 하다. 28강. 필드에서 레코드로 변경 1 2 3 4 5 6 7 8 9 UPDATE ScoreRows SET Score = (SELECT CASE ScoreRows.subject WHEN '영어' THEN score_en WHEN '국어' THEN score_nl WHEN '수학' THEN score_nt ELSE NULL END FROM ScoreCols WHERE student_id = ScoreRow.student_id); 29강. 같은 테이블의 다른 레코드로 갱신 1. 상관 서브쿼리 사용 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 INSERT INTO Stocks2 SELECT brand, sale_date, price, CASE SIGN(price - (SELECT price FROM Stocks S1 WHERE brand = Stocks.brand AND sale_date = (SELECT MAX(sale_date) FROM Stocks S2 WHERE brand = Stocks.brand AND sale_date \u003c Stock.sale_date))) WHEN -1 THEN '아래화살표' WHEN 0 THEN '오른쪽화살표' WHEN 1 THEN '위쪽화살표' ELSE NULL END FROM Stocks S2; 상관서브쿼리 때문에 테이블에 여러번 접근해야 한다. 2. 윈도우 함수 적용 1 2 3 4 5 6 7 8 9 10 11 12 13 INSERT INTO Stocks2 SELECT brand, sale_date, price, CASE SIGN(price - MAX(price) OVER (PARTITION BY brand ORDER BY sale_date ROWS BETWEEN 1 PRECEDING AND 1 PRECEDING)) WHEN -1 THEN '아래화살표' WHEN 0 THEN '오른쪽화살표' WHEN 1 THEN '위쪽화살표' ELSE NULL END FROM Stocks S2; 매우 간단하고 효율적이 된다. 3. INSERT와 UPDATE 어떤 것이 좋을까? INSERT SELECT 장점 처리가 더 빠름 자기참조를 허가하지 않는 DB에서도 사용가능 단점 같은 데이털르 두개 만들어야하므로 저장소를 2배 이상 소비 뷰로 만들어도 되나 트레이드 오프가 있다 30강. 갱신이 초래하는 트레이드오프 주문일과 배송 예정일 차이가 3일 이상 차이나는 것 1. SQL을 사용하는 방법 1 2 3 4 5 6 7 SELECT O.order_id, O.order_name, ORC.delivery_date - O.order_date AS diff_days FROM Orders O INNER JOIN OrderReceipts ORC ON O.order_id = ORC.order_id WHERE ORC.delivery_date - O.order_date \u003e= 3; 주문별로 최대 지연일을 알고 싶은 경우 1 2 3 4 5 6 7 8 SELECT O.order_id, MAX(O.order_name), -- SELECT 하기 위해 MAX를 사용 MAX(ORC.delivery_date - O.order_date) AS max_diff_days FROM Orders O INNER JOIN OrderReceipts ORC ON O.order_id = ORC.order_id WHERE ORC.delivery_date - O.order_date \u003e= 3; GROUP BY O.order_id; 2. 모델 갱신을 사용하는 방법 쿼리를 통해 찾는게 아니라 필드를 하나 추가해 해결할수도 있을 것 코딩 외의 방법도 해결수단이 된다. 31강. 모델 갱신의 주의점 3가지의 트레이드 오프가 있다 1. 높아지는 갱신 비용 배송 지연 플래그 필드를 갱신하는 비용이 든다 2. 갱신까지의 시간 랙 발생 갱신 되기 전까지의 시간차이가 발생 3. 모델 갱신 비용 발생 모델의 수정은 대단히 큰 수정이 요구됨, 특히나 이미 운영을 시작했다면 더욱 더 32강. 시야 협착 : 관련 문제 시야 협착에 빠지기 쉬운 경우를 살펴본다 31강의 문제를 그대로 사용한다 주문번호마다 몇개의 상품이 주문되었는지 확인(주문번호, 주문자 이름, 주문일, 상품수) 1. 다시 SQL을 사용한다면 1 2 3 4 5 6 7 8 SELECT O.order_id, MAX(O.order_name) AS order_name, MAX(O.order_date) AS order_date, COUNT(*) AS item_count FROM Orders O INNER JOIN OrderReceipts ORC ON O.order_id = ORC.order_id GROUP BY O.order_id; 1 2 3 4 5 6 7 SELECT O.order_id, O.order_name, O.order_date, COUNT(*) OVER (PARTITION BY O.order_id) AS item_count FROM Orders O INNER JOIN OrderReceipts ORC ON O.order_id = ORC.order_id; 집약을 쓰든 윈도우 함수를 쓰든 모두 결합과 집약을 수행하기 때문에 실행 비용은 비슷하다. 가독성과 확장성 측면에서 윈도우 함수를 쓰는 것이 더 좋다. 2. 다시 모델 갱신을 사용한다면 주문이 등록될 때 수를 알 수 있으므로 필드를 추가해 개수를 넣기 쉽다. 다만, 주문 변경이 일어나는 경우의 처리를 고려해야 한다. 3. 초보자보다 중급자가 경계해야 33강. 데이터 모델을 지배하는 자가 시스템을 지배한다. 현명한 데이터 구조와 멍청한 코드의 조합이 멍청한 데이터 구조와 현명한 코드의 조합보다 좋다. 엔지니어의 사명은 전략적 실패를 만회하는 전술을 찾는 것이 아닌 올바른 전략을 고려하는 것 34강. 인덱스와 B-tree RDB의 인덱스 구조, 1. B-tree, 2. 비트맵, 3. 해시 1. 만능형 : B-tree 대부분 DB의 B+tree 라는 수정 버전을 사용한다. B+tree는 리프노드에만 키값을 저장한다. B+tree는 루트와 리프의 거리를 가능한 일정하게 유지하려고 하기 때문에 검색 속도가 안정적이다. 2. 기타 인덱스 비트맵 인덱스 : 데이터를 비트 플래그로 변환해서 저장하는 형태의 인덱스로 카디널리티가 낮은 필드에 대해 효과를 발휘한다. 하지만 갱신할 때 오버헤드가 키 BI/DWH 용도로 사용된다. 해시 인덱스 : 검색 외에 효과가 없어 거의 사용되지 않는다. 35강. 인덱스를 잘 활용하려면 B+tree는 양이 증가해도 검색이 안정적이고, 범위 검색도 쉬움 1. 카디널리티(값의 균형)와 선택률(전체중에서 몇개가 선택되는지) 클러스터링 팩터(저장소에 같은 값이 어느정도 물리적으로 뭉쳐 존재하는지)가 낮을수록 좋다. 하지만 이것은 구현에 의족한다. 2. 인덱스를 사용하는 것이 좋은지 판단하려면 카디널리티가 높은 것 선택률이 낮은 것 5 ~ 10 % 이하, 저장소의 성능향상과 반비례한다. 36강. 인덱스로 성능 향상이 어려운 경우 인덱스 설계는 테이블 정의와 SQL만 봐서는 할 수 없다. 1. 압축 조건이 존재하지 않음 WHERE 구가 없이 SELECT 하는 경우 2. 레코드를 제대로 압축하지 못하는 경우 WHERE 구 조건의 선택률이 너무 높아 인덱스를 만들기 비효율적이다. 1) 입력 매개변수에 따라 선택률이 변동하는 경우 - 1 2) 입력 매개변수에 따라 선택률이 변동하는 경우 - 2 3. 인덱스를 사용하지 않는 검색 조건 1) 중간 일치, 후방 일치 LIKE 연산자 LIKE를 사용하는 경우 인덱스는 전방일치에만 적용 가능하다. 2) 색인 필드로 연산하는 경우(함수를 적요하는 경우에도 안됨) 다음과 같이 바꾸면 됨 WHERE col_1 * 1.1 \u003e 100 -\u003e col_1 \u003e 100/1.1 3) IS NULL을 사용하는 경우 색인 필드 데이터에는 NULL이 존재하지 않기 때문에 인덱스를 사용불가 4) 부정형을 사용하는 경우 \u003c\u003e, !=, NOT IN 37강. 인덱스를 사용할 수 없는 경우 대처법 1. 외부 설정으로 처리 - 깊고 어두운 강 건너기 1) UI 설계로 처리 사용자가 선택할 수 있는 조건을 제한한다. 2. 외부 설정을 사용한 대처 방법의 주의점 개발전에 합의해야 한다. 서로의 이해관계를 파악하는 것이 중요! 3. 데이터 맡로 대처 특정한 쿼리에서 필요한 데이터만을 저장하는, 상대적으로 작은 크기의 테이블이다. 서브셋 원래 대규모의 데이터를 다뤄야 하는(성능 조건이 중요함) BI/DWH 분야에 사용되는 기술이다. 접근 대상 테이블의 크기를 작게해서 I/O양을 줄이는 것이 목적이다. 4. 데이터 마트를 채택할 시 주의점 1) 데이터 신선도 동기 시점에 따라 신선도와 성능간의 트레이드 오프 고려 할 것 2) 데이터 마트 크기 I/0 양을 줄이는 것이 목적이므로 테이블의 크기가 딱히 줄어들지 않는다면 필요없다. GROUP BY절을 미리 사용해 집계를 마치고 데이터 마트로 만들면 필드 수와 레코드수를 크게 줄일 수 있다. 3) 데이터 마트수 목적에 맞게 잘 만들어 관리해야, 용량과 성능문제가 안생긴다. 빠르다고 무작점 만들어서 쓰면 안됨 4) 배치 윈도우 데이터 마트도 만드는데 시간이 걸리고 변경에 따른 갱신도 발생하므로 배치 윈도우를 압박한다. 배치윈도우와 Job Net도 고려할 것 5. 인덱스 온리 스캔으로 대처 I/O 감소를 목적으로하는 데이터 마트와 접근이 같고, 데이터 동기 문제를 해결할 수 있다. 풀 스캔을 할 때 검사대상을 테이블이 아닌 인덱스로 바꿀 수 있다. 압축 요건이 존재하지 않는 경우 CREATE INDEX CoveringIndex ON Orders (order_id, receive_date); SQL 구문에서 필요한 필드를 인덱스만으로 커버할 수 있는 경우, 테이블 접근을 생략하는 기술 이다. 레코드를 제대로 압축하지 못하는 검색 조건 CREATE INDEX CoveringIndex_1 ON Orders (process_flg, order_id, receive_date); 압축은 되지만 인덱스를 사용하지 않는 검색 조건 CREATE INDEX CoveringIndex_2 ON Orders (shop_name, order_id, receive_date); 로우 지향 DB를 컬럼 지향 DB로 만드는 방법이라고 생각하면 된다. 6. 인덱스 온리 스캔의 주의사항 1) DBMS에 따라 사용할 수 없는 경우도 있다. 2) 한 개의 인덱스에 포함할 수 있는 필드 수에 제한이 있다. 3) 갱신 오버 헤드가 커진다. 커버링 인덱스는 성질살 필연적으로 필드 수가 많아 크기가 큰 인덱스가 되기 쉽다. 따라서 테이블을 갱신할 때의 오버헤드도 일반적인 인덱스에 비해 커진다. 4) 정기적인 인덱스 리빌드가 필요 인덱스에만 접근한다는 것은 성능이 인덱스의 크기에 의존한다는 것이다. 따라서 정기적인 모니터링과 리빌드를 필요로 한다. 5) SQL에 새로운 필드가 추가되면 사용할 수 없다. 일반적인 인덱스에 비해 어플리케이션 유지 보수에 약한 타입의 튜닝이라고 할 수 있다. ","wordCount":"3724","inLanguage":"ko","datePublished":"2019-05-29T01:39:17+09:00","dateModified":"2019-05-29T01:39:17+09:00","author":{"@type":"Person","name":"Jaejin Jang"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://jaejin0me.github.io/post/posts182/"},"publisher":{"@type":"Organization","name":"Jaejin's blog","logo":{"@type":"ImageObject","url":"https://jaejin0me.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://jaejin0me.github.io accesskey=h title="Jaejin's blog (Alt + H)">Jaejin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://jaejin0me.github.io/ title=Home><span>Home</span></a></li><li><a href=https://jaejin0me.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://jaejin0me.github.io/post/ title=Posts><span>Posts</span></a></li><li><a href=https://jaejin0me.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://jaejin0me.github.io/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://jaejin0me.github.io/about/ title="About Me"><span>About Me</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>책뿌숴짐 - SQL 레벨업 9</h1><div class=post-meta><span title='2019-05-29 01:39:17 +0900 +0900'>5월 29, 2019</span>&nbsp;·&nbsp;Jaejin Jang</div></header><div class=post-content><h1 id=9장-갱신과-데이터-모델---망치와-못>9장. 갱신과 데이터 모델 - 망치와 못<a hidden class=anchor aria-hidden=true href=#9장-갱신과-데이터-모델---망치와-못>#</a></h1><h2 id=26강-갱신을-효율적으로>26강. 갱신을 효율적으로<a hidden class=anchor aria-hidden=true href=#26강-갱신을-효율적으로>#</a></h2><ul><li>갱신을 효율적으로 수행하는 SQL을 케이스 스터디</li></ul><h3 id=1-null-채우기>1. NULL 채우기<a hidden class=anchor aria-hidden=true href=#1-null-채우기>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>OmitTbl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>OmitTbl</span><span class=w>	</span><span class=n>OT1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>OT1</span><span class=p>.</span><span class=n>keycol</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>seq</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>OmitTbl</span><span class=w> </span><span class=n>OT2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>OT2</span><span class=p>.</span><span class=n>keycol</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OmitTbl</span><span class=p>.</span><span class=n>keycol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>OT2</span><span class=p>.</span><span class=n>seq</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>OmitTbl</span><span class=p>.</span><span class=n>seq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>OT2</span><span class=p>.</span><span class=n>val</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-반대로-null을-설정>2. 반대로 NULL을 설정<a hidden class=anchor aria-hidden=true href=#2-반대로-null을-설정>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>OmitTbl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>val</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>OmitTbl</span><span class=w> </span><span class=mi>01</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=mi>01</span><span class=p>.</span><span class=n>keycol</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OmitTbl</span><span class=p>.</span><span class=n>keycol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=mi>01</span><span class=p>.</span><span class=n>seq</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>seq</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>OmitTbl</span><span class=w> </span><span class=mi>02</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=mi>02</span><span class=p>.</span><span class=n>keycol</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OmitTbl</span><span class=p>.</span><span class=n>keycol</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=mi>02</span><span class=p>.</span><span class=n>seq</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>OmitTbl</span><span class=p>.</span><span class=n>seq</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 	</span><span class=k>THEN</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 	</span><span class=k>ELSE</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=k>END</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=27강-레코드에서-필드로의-갱신>27강. 레코드에서 필드로의 갱신<a hidden class=anchor aria-hidden=true href=#27강-레코드에서-필드로의-갱신>#</a></h2><h3 id=1-필드를-하나씩-갱신>1. 필드를 하나씩 갱신<a hidden class=anchor aria-hidden=true href=#1-필드를-하나씩-갱신>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>ScoreCols</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>score_en</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;영어&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>score_nl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;국어&#39;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>score_mt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;수학&#39;</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>명확하지만 항목별로 서브쿼리를 필요로하기 때문에 비효율적이다.</li></ul><h3 id=2-다중-필드-할당>2. 다중 필드 할당<a hidden class=anchor aria-hidden=true href=#2-다중-필드-할당>#</a></h3><ul><li>여러 개의 필드를 리스트화하고 한번에 갱신</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>ScoreCols</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=p>(</span><span class=n>score_en</span><span class=p>,</span><span class=w> </span><span class=n>score_nl</span><span class=p>,</span><span class=w> </span><span class=n>score_mt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;영어&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>score_en</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;국어&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>score_nl</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;수학&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>score_mt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRows</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>student_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>student_id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>상관 서브쿼리가 하나로 정리된 대신, ScoreRows 테이블에 대한 접근이 INDEX UNIQUE SCAN -> INDEX RANGE SCAN, MAX 함수의 정렬리 추가되므로 트레이드오프가 있다.</li></ul><h4 id=1-다중-필드-할당>1) 다중 필드 할당<a hidden class=anchor aria-hidden=true href=#1-다중-필드-할당>#</a></h4><h4 id=2-스칼라-서브쿼리>2) 스칼라 서브쿼리<a hidden class=anchor aria-hidden=true href=#2-스칼라-서브쿼리>#</a></h4><ul><li>MAX함수를 적용해 집약시킴으로써 가능해진다.</li></ul><h3 id=3-not-null-제약이-걸려있는-경>3. NOT NULL 제약이 걸려있는 경<a hidden class=anchor aria-hidden=true href=#3-not-null-제약이-걸려있는-경>#</a></h3><h4 id=1-update-구문-사용>1) UPDATE 구문 사용<a hidden class=anchor aria-hidden=true href=#1-update-구문-사용>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>ScoreColsNN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>score_en</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>COALESCE</span><span class=p>((</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;영어&#39;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>score_nl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>COALESCE</span><span class=p>((</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;국어&#39;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>score_mt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>COALESCE</span><span class=p>((</span><span class=k>SELECT</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRow</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHERE</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>studend_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreCols</span><span class=p>.</span><span class=n>studend_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>AND</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;수학&#39;</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>WHERE</span><span class=w> </span><span class=n>student_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreColsNN</span><span class=p>.</span><span class=n>studend_id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>테이블 사이에 일치하지 않는 레코드는 제거</li><li>학생은 존재하지만 과목이 없는 경우 처리</li></ul><h4 id=2-merge-구문-사용>2) MERGE 구문 사용<a hidden class=anchor aria-hidden=true href=#2-merge-구문-사용>#</a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>MERGE</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>ScoreColsNN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>USING</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>student_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>COALESCE</span><span class=p>(</span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;영어&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Score_en</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>COALESCE</span><span class=p>(</span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;국어&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Score_nl</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>COALESCE</span><span class=p>(</span><span class=k>MAX</span><span class=p>(</span><span class=k>CASE</span><span class=w> </span><span class=k>WHEN</span><span class=w> </span><span class=n>subject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;수학&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>THEN</span><span class=w> </span><span class=n>score</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>END</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Score_mt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreRows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>GROUP</span><span class=w> </span><span class=k>By</span><span class=w> </span><span class=n>studend_id</span><span class=p>)</span><span class=w> </span><span class=n>SR</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>ON</span><span class=w>	</span><span class=p>(</span><span class=n>ScoreColsNN</span><span class=p>.</span><span class=n>student_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>student_id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=n>MATCHED</span><span class=w> </span><span class=k>THEN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>UPDATE</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>ScoreColsNN</span><span class=p>.</span><span class=n>score_en</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>score_en</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>coreColsNN</span><span class=p>.</span><span class=n>score_nl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>score_nl</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=n>ScoreColsNN</span><span class=p>.</span><span class=n>score_mt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SR</span><span class=p>.</span><span class=n>score_mt</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>결합조건을 ON 구 하나에 묶을 수 있다.</li><li>ScoreRows 테이블 풀 스캔 1회 + 정렬 1회로 고정된다.</li><li>나은 선택지로 고려해볼만 하다.</li></ul><h2 id=28강-필드에서-레코드로-변경>28강. 필드에서 레코드로 변경<a hidden class=anchor aria-hidden=true href=#28강-필드에서-레코드로-변경>#</a></h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>UPDATE</span><span class=w> </span><span class=n>ScoreRows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>SET</span><span class=w> </span><span class=n>Score</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>CASE</span><span class=w> </span><span class=n>ScoreRows</span><span class=p>.</span><span class=n>subject</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHEN</span><span class=w> </span><span class=s1>&#39;영어&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=n>score_en</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHEN</span><span class=w> </span><span class=s1>&#39;국어&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=n>score_nl</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WHEN</span><span class=w> </span><span class=s1>&#39;수학&#39;</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=n>score_nt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>END</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>FROM</span><span class=w> </span><span class=n>ScoreCols</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHERE</span><span class=w> </span><span class=n>student_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ScoreRow</span><span class=p>.</span><span class=n>student_id</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h2 id=29강-같은-테이블의-다른-레코드로-갱신>29강. 같은 테이블의 다른 레코드로 갱신<a hidden class=anchor aria-hidden=true href=#29강-같은-테이블의-다른-레코드로-갱신>#</a></h2><h3 id=1-상관-서브쿼리-사용>1. 상관 서브쿼리 사용<a hidden class=anchor aria-hidden=true href=#1-상관-서브쿼리-사용>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Stocks2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>brand</span><span class=p>,</span><span class=w> </span><span class=n>sale_date</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>CASE</span><span class=w> </span><span class=n>SIGN</span><span class=p>(</span><span class=n>price</span><span class=w> </span><span class=o>-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>price</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>FROM</span><span class=w> </span><span class=n>Stocks</span><span class=w> </span><span class=n>S1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>WHERE</span><span class=w> </span><span class=n>brand</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stocks</span><span class=p>.</span><span class=n>brand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>AND</span><span class=w> </span><span class=n>sale_date</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>sale_date</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>FROM</span><span class=w> </span><span class=n>Stocks</span><span class=w> </span><span class=n>S2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>WHERE</span><span class=w> </span><span class=n>brand</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stocks</span><span class=p>.</span><span class=n>brand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=k>AND</span><span class=w> </span><span class=n>sale_date</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>Stock</span><span class=p>.</span><span class=n>sale_date</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;아래화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;오른쪽화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;위쪽화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>END</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Stocks</span><span class=w> </span><span class=n>S2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>상관서브쿼리 때문에 테이블에 여러번 접근해야 한다.</li></ul><h3 id=2-윈도우-함수-적용>2. 윈도우 함수 적용<a hidden class=anchor aria-hidden=true href=#2-윈도우-함수-적용>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Stocks2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>brand</span><span class=p>,</span><span class=w> </span><span class=n>sale_date</span><span class=p>,</span><span class=w> </span><span class=n>price</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>CASE</span><span class=w> </span><span class=n>SIGN</span><span class=p>(</span><span class=n>price</span><span class=w> </span><span class=o>-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>MAX</span><span class=p>(</span><span class=n>price</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>brand</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>sale_date</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>ROWS</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>PRECEDING</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=k>AND</span><span class=w>  </span><span class=mi>1</span><span class=w> </span><span class=n>PRECEDING</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;아래화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;오른쪽화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>WHEN</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;위쪽화살표&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>ELSE</span><span class=w> </span><span class=k>NULL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>END</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Stocks</span><span class=w> </span><span class=n>S2</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>매우 간단하고 효율적이 된다.</li></ul><h3 id=3-insert와-update-어떤-것이-좋을까>3. INSERT와 UPDATE 어떤 것이 좋을까?<a hidden class=anchor aria-hidden=true href=#3-insert와-update-어떤-것이-좋을까>#</a></h3><ul><li>INSERT SELECT 장점</li><li>처리가 더 빠름</li><li>자기참조를 허가하지 않는 DB에서도 사용가능</li><li>단점</li><li>같은 데이털르 두개 만들어야하므로 저장소를 2배 이상 소비</li><li>뷰로 만들어도 되나 트레이드 오프가 있다</li></ul><h2 id=30강-갱신이-초래하는-트레이드오프>30강. 갱신이 초래하는 트레이드오프<a hidden class=anchor aria-hidden=true href=#30강-갱신이-초래하는-트레이드오프>#</a></h2><ul><li>주문일과 배송 예정일 차이가 3일 이상 차이나는 것</li></ul><h3 id=1-sql을-사용하는-방법>1. SQL을 사용하는 방법<a hidden class=anchor aria-hidden=true href=#1-sql을-사용하는-방법>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>O</span><span class=p>.</span><span class=n>order_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>ORC</span><span class=p>.</span><span class=n>delivery_date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>diff_days</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>O</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderReceipts</span><span class=w> </span><span class=n>ORC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>order_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>delivery_date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>주문별로 최대 지연일을 알고 싶은 경우</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>MAX</span><span class=p>(</span><span class=n>O</span><span class=p>.</span><span class=n>order_name</span><span class=p>),</span><span class=w> </span><span class=c1>-- SELECT 하기 위해 MAX를 사용
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>	</span><span class=k>MAX</span><span class=p>(</span><span class=n>ORC</span><span class=p>.</span><span class=n>delivery_date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>max_diff_days</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>O</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderReceipts</span><span class=w> </span><span class=n>ORC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>order_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>delivery_date</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=2-모델-갱신을-사용하는-방법>2. 모델 갱신을 사용하는 방법<a hidden class=anchor aria-hidden=true href=#2-모델-갱신을-사용하는-방법>#</a></h3><ul><li>쿼리를 통해 찾는게 아니라 필드를 하나 추가해 해결할수도 있을 것</li><li>코딩 외의 방법도 해결수단이 된다.</li></ul><h2 id=31강-모델-갱신의-주의점>31강. 모델 갱신의 주의점<a hidden class=anchor aria-hidden=true href=#31강-모델-갱신의-주의점>#</a></h2><ul><li>3가지의 트레이드 오프가 있다</li></ul><h3 id=1-높아지는-갱신-비용>1. 높아지는 갱신 비용<a hidden class=anchor aria-hidden=true href=#1-높아지는-갱신-비용>#</a></h3><ul><li>배송 지연 플래그 필드를 갱신하는 비용이 든다</li></ul><h3 id=2-갱신까지의-시간-랙-발생>2. 갱신까지의 시간 랙 발생<a hidden class=anchor aria-hidden=true href=#2-갱신까지의-시간-랙-발생>#</a></h3><ul><li>갱신 되기 전까지의 시간차이가 발생</li></ul><h3 id=3-모델-갱신-비용-발생>3. 모델 갱신 비용 발생<a hidden class=anchor aria-hidden=true href=#3-모델-갱신-비용-발생>#</a></h3><ul><li>모델의 수정은 대단히 큰 수정이 요구됨, 특히나 이미 운영을 시작했다면 더욱 더</li></ul><h2 id=32강-시야-협착--관련-문제>32강. 시야 협착 : 관련 문제<a hidden class=anchor aria-hidden=true href=#32강-시야-협착--관련-문제>#</a></h2><ul><li>시야 협착에 빠지기 쉬운 경우를 살펴본다</li><li>31강의 문제를 그대로 사용한다</li><li>주문번호마다 몇개의 상품이 주문되었는지 확인(주문번호, 주문자 이름, 주문일, 상품수)</li></ul><h3 id=1-다시-sql을-사용한다면>1. 다시 SQL을 사용한다면<a hidden class=anchor aria-hidden=true href=#1-다시-sql을-사용한다면>#</a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>MAX</span><span class=p>(</span><span class=n>O</span><span class=p>.</span><span class=n>order_name</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>order_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>MAX</span><span class=p>(</span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>order_date</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>item_count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>O</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderReceipts</span><span class=w> </span><span class=n>ORC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>order_id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	   </span><span class=n>O</span><span class=p>.</span><span class=n>order_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	   </span><span class=n>O</span><span class=p>.</span><span class=n>order_date</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	   </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=n>OVER</span><span class=w> </span><span class=p>(</span><span class=n>PARTITION</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>item_count</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>O</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderReceipts</span><span class=w> </span><span class=n>ORC</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>ON</span><span class=w> </span><span class=n>O</span><span class=p>.</span><span class=n>order_id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ORC</span><span class=p>.</span><span class=n>order_id</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>집약을 쓰든 윈도우 함수를 쓰든 모두 결합과 집약을 수행하기 때문에 실행 비용은 비슷하다. 가독성과 확장성 측면에서 윈도우 함수를 쓰는 것이 더 좋다.</li></ul><h3 id=2-다시-모델-갱신을-사용한다면>2. 다시 모델 갱신을 사용한다면<a hidden class=anchor aria-hidden=true href=#2-다시-모델-갱신을-사용한다면>#</a></h3><ul><li>주문이 등록될 때 수를 알 수 있으므로 필드를 추가해 개수를 넣기 쉽다. 다만, 주문 변경이 일어나는 경우의 처리를 고려해야 한다.</li></ul><h3 id=3-초보자보다-중급자가-경계해야>3. 초보자보다 중급자가 경계해야<a hidden class=anchor aria-hidden=true href=#3-초보자보다-중급자가-경계해야>#</a></h3><h2 id=33강-데이터-모델을-지배하는-자가-시스템을-지배한다>33강. 데이터 모델을 지배하는 자가 시스템을 지배한다.<a hidden class=anchor aria-hidden=true href=#33강-데이터-모델을-지배하는-자가-시스템을-지배한다>#</a></h2><ul><li>현명한 데이터 구조와 멍청한 코드의 조합이 멍청한 데이터 구조와 현명한 코드의 조합보다 좋다.</li><li>엔지니어의 사명은 전략적 실패를 만회하는 전술을 찾는 것이 아닌 올바른 전략을 고려하는 것</li></ul><h2 id=34강-인덱스와-b-tree>34강. 인덱스와 B-tree<a hidden class=anchor aria-hidden=true href=#34강-인덱스와-b-tree>#</a></h2><ul><li>RDB의 인덱스 구조, 1. B-tree, 2. 비트맵, 3. 해시</li></ul><h3 id=1-만능형--b-tree>1. 만능형 : B-tree<a hidden class=anchor aria-hidden=true href=#1-만능형--b-tree>#</a></h3><ul><li>대부분 DB의 B+tree 라는 수정 버전을 사용한다.</li><li>B+tree는 리프노드에만 키값을 저장한다.</li><li>B+tree는 루트와 리프의 거리를 가능한 일정하게 유지하려고 하기 때문에 검색 속도가 안정적이다.</li></ul><h3 id=2-기타-인덱스>2. 기타 인덱스<a hidden class=anchor aria-hidden=true href=#2-기타-인덱스>#</a></h3><ul><li>비트맵 인덱스 : 데이터를 비트 플래그로 변환해서 저장하는 형태의 인덱스로 카디널리티가 낮은 필드에 대해 효과를 발휘한다. 하지만 갱신할 때 오버헤드가 키 BI/DWH 용도로 사용된다.</li><li>해시 인덱스 : 검색 외에 효과가 없어 거의 사용되지 않는다.</li></ul><h2 id=35강-인덱스를-잘-활용하려면>35강. 인덱스를 잘 활용하려면<a hidden class=anchor aria-hidden=true href=#35강-인덱스를-잘-활용하려면>#</a></h2><ul><li>B+tree는 양이 증가해도 검색이 안정적이고, 범위 검색도 쉬움</li></ul><h3 id=1-카디널리티값의-균형와-선택률전체중에서-몇개가-선택되는지>1. 카디널리티(값의 균형)와 선택률(전체중에서 몇개가 선택되는지)<a hidden class=anchor aria-hidden=true href=#1-카디널리티값의-균형와-선택률전체중에서-몇개가-선택되는지>#</a></h3><ul><li>클러스터링 팩터(저장소에 같은 값이 어느정도 물리적으로 뭉쳐 존재하는지)가 낮을수록 좋다. 하지만 이것은 구현에 의족한다.</li></ul><h3 id=2-인덱스를-사용하는-것이-좋은지-판단하려면>2. 인덱스를 사용하는 것이 좋은지 판단하려면<a hidden class=anchor aria-hidden=true href=#2-인덱스를-사용하는-것이-좋은지-판단하려면>#</a></h3><ul><li>카디널리티가 높은 것</li><li>선택률이 낮은 것 5 ~ 10 % 이하, 저장소의 성능향상과 반비례한다.</li></ul><h2 id=36강-인덱스로-성능-향상이-어려운-경우>36강. 인덱스로 성능 향상이 어려운 경우<a hidden class=anchor aria-hidden=true href=#36강-인덱스로-성능-향상이-어려운-경우>#</a></h2><ul><li>인덱스 설계는 테이블 정의와 SQL만 봐서는 할 수 없다.</li></ul><h3 id=1-압축-조건이-존재하지-않음>1. 압축 조건이 존재하지 않음<a hidden class=anchor aria-hidden=true href=#1-압축-조건이-존재하지-않음>#</a></h3><ul><li>WHERE 구가 없이 SELECT 하는 경우</li></ul><h3 id=2-레코드를-제대로-압축하지-못하는-경우>2. 레코드를 제대로 압축하지 못하는 경우<a hidden class=anchor aria-hidden=true href=#2-레코드를-제대로-압축하지-못하는-경우>#</a></h3><ul><li>WHERE 구 조건의 선택률이 너무 높아 인덱스를 만들기 비효율적이다.</li></ul><h4 id=1-입력-매개변수에-따라-선택률이-변동하는-경우---1>1) 입력 매개변수에 따라 선택률이 변동하는 경우 - 1<a hidden class=anchor aria-hidden=true href=#1-입력-매개변수에-따라-선택률이-변동하는-경우---1>#</a></h4><h4 id=2-입력-매개변수에-따라-선택률이-변동하는-경우---2>2) 입력 매개변수에 따라 선택률이 변동하는 경우 - 2<a hidden class=anchor aria-hidden=true href=#2-입력-매개변수에-따라-선택률이-변동하는-경우---2>#</a></h4><h3 id=3-인덱스를-사용하지-않는-검색-조건>3. 인덱스를 사용하지 않는 검색 조건<a hidden class=anchor aria-hidden=true href=#3-인덱스를-사용하지-않는-검색-조건>#</a></h3><h4 id=1-중간-일치-후방-일치-like-연산자>1) 중간 일치, 후방 일치 LIKE 연산자<a hidden class=anchor aria-hidden=true href=#1-중간-일치-후방-일치-like-연산자>#</a></h4><ul><li>LIKE를 사용하는 경우 인덱스는 전방일치에만 적용 가능하다.</li></ul><h4 id=2-색인-필드로-연산하는-경우함수를-적요하는-경우에도-안됨>2) 색인 필드로 연산하는 경우(함수를 적요하는 경우에도 안됨)<a hidden class=anchor aria-hidden=true href=#2-색인-필드로-연산하는-경우함수를-적요하는-경우에도-안됨>#</a></h4><ul><li>다음과 같이 바꾸면 됨</li><li>WHERE col_1 * 1.1 > 100 -> col_1 > 100/1.1</li></ul><h4 id=3-is-null을-사용하는-경우>3) IS NULL을 사용하는 경우<a hidden class=anchor aria-hidden=true href=#3-is-null을-사용하는-경우>#</a></h4><ul><li>색인 필드 데이터에는 NULL이 존재하지 않기 때문에 인덱스를 사용불가</li></ul><h4 id=4-부정형을-사용하는-경우>4) 부정형을 사용하는 경우<a hidden class=anchor aria-hidden=true href=#4-부정형을-사용하는-경우>#</a></h4><ul><li>&lt;>, !=, NOT IN</li></ul><h2 id=37강-인덱스를-사용할-수-없는-경우-대처법>37강. 인덱스를 사용할 수 없는 경우 대처법<a hidden class=anchor aria-hidden=true href=#37강-인덱스를-사용할-수-없는-경우-대처법>#</a></h2><h3 id=1-외부-설정으로-처리---깊고-어두운-강-건너기>1. 외부 설정으로 처리 - 깊고 어두운 강 건너기<a hidden class=anchor aria-hidden=true href=#1-외부-설정으로-처리---깊고-어두운-강-건너기>#</a></h3><h4 id=1-ui-설계로-처리>1) UI 설계로 처리<a hidden class=anchor aria-hidden=true href=#1-ui-설계로-처리>#</a></h4><ul><li>사용자가 선택할 수 있는 조건을 제한한다.</li></ul><h3 id=2-외부-설정을-사용한-대처-방법의-주의점>2. 외부 설정을 사용한 대처 방법의 주의점<a hidden class=anchor aria-hidden=true href=#2-외부-설정을-사용한-대처-방법의-주의점>#</a></h3><ul><li>개발전에 합의해야 한다. 서로의 이해관계를 파악하는 것이 중요!</li></ul><h3 id=3-데이터-맡로-대처>3. 데이터 맡로 대처<a hidden class=anchor aria-hidden=true href=#3-데이터-맡로-대처>#</a></h3><ul><li>특정한 쿼리에서 필요한 데이터만을 저장하는, 상대적으로 작은 크기의 테이블이다. 서브셋</li><li>원래 대규모의 데이터를 다뤄야 하는(성능 조건이 중요함) BI/DWH 분야에 사용되는 기술이다. 접근 대상 테이블의 크기를 작게해서 I/O양을 줄이는 것이 목적이다.</li></ul><h3 id=4-데이터-마트를-채택할-시-주의점>4. 데이터 마트를 채택할 시 주의점<a hidden class=anchor aria-hidden=true href=#4-데이터-마트를-채택할-시-주의점>#</a></h3><h4 id=1-데이터-신선도>1) 데이터 신선도<a hidden class=anchor aria-hidden=true href=#1-데이터-신선도>#</a></h4><ul><li>동기 시점에 따라 신선도와 성능간의 트레이드 오프 고려 할 것</li></ul><h4 id=2-데이터-마트-크기>2) 데이터 마트 크기<a hidden class=anchor aria-hidden=true href=#2-데이터-마트-크기>#</a></h4><ul><li>I/0 양을 줄이는 것이 목적이므로 테이블의 크기가 딱히 줄어들지 않는다면 필요없다.</li><li>GROUP BY절을 미리 사용해 집계를 마치고 데이터 마트로 만들면 필드 수와 레코드수를 크게 줄일 수 있다.</li></ul><h4 id=3-데이터-마트수>3) 데이터 마트수<a hidden class=anchor aria-hidden=true href=#3-데이터-마트수>#</a></h4><ul><li>목적에 맞게 잘 만들어 관리해야, 용량과 성능문제가 안생긴다.</li><li>빠르다고 무작점 만들어서 쓰면 안됨</li></ul><h4 id=4-배치-윈도우>4) 배치 윈도우<a hidden class=anchor aria-hidden=true href=#4-배치-윈도우>#</a></h4><ul><li>데이터 마트도 만드는데 시간이 걸리고 변경에 따른 갱신도 발생하므로 배치 윈도우를 압박한다. 배치윈도우와 Job Net도 고려할 것</li></ul><h3 id=5-인덱스-온리-스캔으로-대처>5. 인덱스 온리 스캔으로 대처<a hidden class=anchor aria-hidden=true href=#5-인덱스-온리-스캔으로-대처>#</a></h3><ul><li>I/O 감소를 목적으로하는 데이터 마트와 접근이 같고, 데이터 동기 문제를 해결할 수 있다.</li><li>풀 스캔을 할 때 검사대상을 테이블이 아닌 인덱스로 바꿀 수 있다.</li><li>압축 요건이 존재하지 않는 경우</li><li>CREATE INDEX CoveringIndex ON Orders (order_id, receive_date);</li><li>SQL 구문에서 필요한 필드를 인덱스만으로 커버할 수 있는 경우, 테이블 접근을 생략하는 기술 이다.</li><li>레코드를 제대로 압축하지 못하는 검색 조건</li><li>CREATE INDEX CoveringIndex_1 ON Orders (process_flg, order_id, receive_date);</li><li>압축은 되지만 인덱스를 사용하지 않는 검색 조건</li><li>CREATE INDEX CoveringIndex_2 ON Orders (shop_name, order_id, receive_date);</li><li>로우 지향 DB를 컬럼 지향 DB로 만드는 방법이라고 생각하면 된다.</li></ul><h3 id=6-인덱스-온리-스캔의-주의사항>6. 인덱스 온리 스캔의 주의사항<a hidden class=anchor aria-hidden=true href=#6-인덱스-온리-스캔의-주의사항>#</a></h3><h4 id=1-dbms에-따라-사용할-수-없는-경우도-있다>1) DBMS에 따라 사용할 수 없는 경우도 있다.<a hidden class=anchor aria-hidden=true href=#1-dbms에-따라-사용할-수-없는-경우도-있다>#</a></h4><h4 id=2-한-개의-인덱스에-포함할-수-있는-필드-수에-제한이-있다>2) 한 개의 인덱스에 포함할 수 있는 필드 수에 제한이 있다.<a hidden class=anchor aria-hidden=true href=#2-한-개의-인덱스에-포함할-수-있는-필드-수에-제한이-있다>#</a></h4><h4 id=3-갱신-오버-헤드가-커진다>3) 갱신 오버 헤드가 커진다.<a hidden class=anchor aria-hidden=true href=#3-갱신-오버-헤드가-커진다>#</a></h4><ul><li>커버링 인덱스는 성질살 필연적으로 필드 수가 많아 크기가 큰 인덱스가 되기 쉽다.</li><li>따라서 테이블을 갱신할 때의 오버헤드도 일반적인 인덱스에 비해 커진다.</li></ul><h4 id=4-정기적인-인덱스-리빌드가-필요>4) 정기적인 인덱스 리빌드가 필요<a hidden class=anchor aria-hidden=true href=#4-정기적인-인덱스-리빌드가-필요>#</a></h4><ul><li>인덱스에만 접근한다는 것은 성능이 인덱스의 크기에 의존한다는 것이다. 따라서 정기적인 모니터링과 리빌드를 필요로 한다.</li></ul><h4 id=5-sql에-새로운-필드가-추가되면-사용할-수-없다>5) SQL에 새로운 필드가 추가되면 사용할 수 없다.<a hidden class=anchor aria-hidden=true href=#5-sql에-새로운-필드가-추가되면-사용할-수-없다>#</a></h4><ul><li>일반적인 인덱스에 비해 어플리케이션 유지 보수에 약한 타입의 튜닝이라고 할 수 있다.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://jaejin0me.github.io/tags/sql-%ED%8A%9C%EB%8B%9D/>sql 튜닝</a></li></ul></footer></article></main><footer class=footer><span>Jaejin Jang</span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>